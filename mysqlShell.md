---
title: MySQL Shell
tags:                      
- mysql shell
categories:                
- 教程
- MySQL Shell
date: 2018-11-5
---

如有疑问，可以查看官方文档或者下面两篇文章

> <https://mysql.wisborg.dk/2018/08/02/configuring-the-mysql-shell-prompt/>
> <https://mysql.wisborg.dk/2018/10/31/mysql-shell-8-0-13-prompt-now-with-new-line-support/>

MySQL Shell is an advanced client and code editor for MySQL Server.
MySQL Shell 8.0 is highly recommended for use with MySQL Server 8.0 and 5.7. 

## 相关命令

> <https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-commands.html>

```sql
$ mysqlsh
MySQL Shell 8.0.13

Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type '\help' or '\?' for help; '\quit' to exit.


MySQL  JS > \connect root@127.0.0.1:3303

MySQL  127.0.0.1:3303 ssl  JS > \source /tmp/mydata.sql
Failed to open file '/tmp/mydata.sql', error: No such file or directory

MySQL  127.0.0.1:3303 ssl  mysql  JS > \sql
Switching to SQL mode... Commands end with ;
Fetching table and column names from `mysql` for auto-completion... Press ^C to stop.

MySQL  127.0.0.1:3303 ssl  mysql  SQL > 
```

在mysql shell里使用sql命令

```sql
\sql
Switch execution mode to SQL.
```

Use MySQL Shell to execute the content of the file code.sql as SQL.

```bash
shell> mysqlsh --sql < code.sql
```

## MySQL Shell Commands

```bash
\
In SQL mode, begin multiple-line mode. Code is cached and executed when an empty line is entered.

\status \s
Show the current MySQL Shell status.

\connect   \c
Connect to a MySQL Server

\reconnect
Reconnect to the same MySQL Server

\source   \.
Execute a script file using the active language.

\warnings   \W
Show any warnings generated by a statement.

\nowarnings \w
Do not show any warnings generated by a statement.

\history
View and edit command line history.

\rehash
Manually update the autocomplete name cache
```

### 历史命令

```sql
MySQL  127.0.0.1:3303 ssl  mysql  SQL > \history
   1  \connect root@127.0.0.1:3303
   2  \connect --mysql root@127.0.0.1:3303
   3  \source /tmp/mydata.sql
   5  \use mysql
   7  \show tables;
   8  \sql
   9  use mysql
  10  show tables;

MySQL  127.0.0.1:3303 ssl  mysql  SQL > 
```

The \history command provides the following options:

- Use `\history save` to save the history manually.
- Use `\history delete entrynumber` to delete the individual history entry with the given number.
- Use `\history delete firstnumber-lastnumber` to delete history entries within the range of the given entry numbers. If lastnumber goes past the last found history entry number, history entries are deleted up to and including the last entry.
- Use `\history delete number-` to delete the history entries from number up to and including the last entry.
- Use `\history delete -number` to delete the specified number of history entries starting with the last entry and working back. For example, \history delete -10 deletes the last 10 history entries.
- Use `\history clear` to delete the entire history.

For more information, see Section 3.4, “MySQL Shell Code History”.

## Code Autocompletion 代码自动完成

> <https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-autocompletion.html>

与 python 和 JavaScript 相关的内容已经删除，因为不需要。
代码补全默认开启，如何关闭？有方法。不知道，因为不需要。

MySQL Shell supports autocompletion of text preceding the cursor by pressing the Tab key. The Section 4.1, “MySQL Shell Commands” can be autocompleted in any of the language modes. For example typing \con and pressing the Tab key autocompletes to \connect. Autocompletion is available for SQL, JavaScript and Python language keywords depending on the current Section 3.1, “Active Language”.

Autocompletion supports the following text objects:

- In SQL mode - autocompletion is aware of schema names, table names, column names of the current active schema.

By default autocompletion is enabled, to change this behavior see Configuring Autocompletion.

Once you activate autocompletion, if the text preceding the cursor has exactly one possible match, the text is automatically completed. If autocompletion finds multiple possible matches, it beeps or flashes the terminal. If the Tab key is pressed again, a list of the possible completions is displayed. If no match is found then no autocompletion happens.

### Autocompleting SQL

When MySQL Shell is in SQL mode, autocompletion tries to complete any word with all possible completions that match. In SQL mode the following can be autocompleted:

- SQL keywords - List of known SQL keywords. Matching is case-insensitive.
- SQL snippets - Certain common snippets, such as SHOW CREATE TABLE, ALTER TABLE, CREATE TABLE, and so on.
- Table names - If there is an active schema and database name caching is not disabled, all the tables of the active schema are used as possible completions.

As a special exception, if a backtick is found, only table names are considered for completion. In SQL mode, autocompletion is not context aware, meaning there is no filtering of completions based on the SQL grammar. In other words, autocompleting SEL returns SELECT, but it could also include a table called selfies.

### Multiple-line Support

It is possible to specify statements over multiple lines. 
In SQL mode multiple line mode starts when the command `\` is issued.

Once multiple-line mode is started, the subsequently entered statements are cached.

**For example:**

```sql
mysql-sql> \
... create procedure get_actors()
... begin
...   select first_name from sakila.actor;
... end
...
mysql-sql>
```

### Upgrade Checker Utility

实例升级又怎么能让一个软件决定。这个不需要。

> <https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-utilities-upgrade.html>

### MySQL Shell Connections

> <https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-connections.html>
> <https://stackoverflow.com/questions/176264/what-is-the-difference-between-a-uri-a-url-and-a-urn>
> <https://dev.mysql.com/doc/refman/8.0/en/connecting-using-path.html#connecting-using-paths-data-dictionary>

`Connecting using a URI String` OR `Connecting using a Data Dictionary`

没什么需要注意的东西，只是有些参数如果不指定，会使用默认值。如 `port 3306`,`/tmp/mysql.sock` 等。

## Pluggable Password Store

**除非提示保存密码，否则不会保存密码。**

To make working with MySQL Shell more fluent and secure you can persist the password for a server connection using a secret store, such as a keychain. You enter the password for a connection interactively and it is stored with the server URL as credentials for the connection. 

Once the password for a server URL is stored, whenever MySQL Shell opens a session it retrieves the password from the configured Secret Store Helper to log in to the server without having to enter the password interactively. The same holds for a script executed by MySQL Shell. If no Secret Store Helper is configured the password is requested interactively.

### Important

MySQL Shell only persists the server URL and password through the means of a Secret Store and does not persist the password on its own.

passwords are only persisted when they are entered manually. If a password is provided using either a server URI type string or at the command line when running mysqlsh it is not persisted.

##  mysql_config_editor — MySQL Configuration Utility

> <https://dev.mysql.com/doc/refman/8.0/en/mysql-config-editor.html>

## Application Log

The location of the log file is the user configuration path and the file is named `mysqlsh.log`.

By default, logging is disabled in MySQL Shell. To enable logging use the `--log-level` command-line option when starting MySQL Shell.

The value assigned to `--log-level` controls the level of detail in the log. The following logging levels are supported:

|Logging Level - Numeric| Logging Level - Text|Meaning|
| --- | --- | --- |
|1|none|None, the default|
|2|internal|Internal Error|
|3|error|Error|
|4|warning|Warning|
|5|info|Informational|
|6|debug|Debug|
|7|debug2|Debug2|
|8|debug3|Debug3|

You can specify the logging level using its text name or the numeric equivalent, so the following examples have the same effect:

```bash
shell> mysqlsh --log-level=4
shell> mysqlsh --log-level=warning
```

If you prepend the logging level with `@` (at sign), log entries are output to an additional viewable location as well as being written to the MySQL Shell log file. The following examples have the same effect:

```bash
shell> mysqlsh --log-level=@8
shell> mysqlsh --log-level=@debug3
```

**注意**
慎用此功能，因为会同时将错误日志输出到屏幕。如下所示，如果内容过多，将会影响操作

```sql
MySQL  127.0.0.1:3303 ssl  SQL > SHOW variables like 'MYSQL_USER_CONFIG_HOME';
Empty set (0.0118 sec)
2018-11-04 06:07:48: Debug: Empty set (0.0118 sec)
```

The MySQL Shell log file format is plain text and entries contain a timestamp and description of the problem, along with the logging level from the above list. 

### Log File Location on Windows

On Windows, the default path to the log file is `%APPDATA%\MySQL\mysqlsh\mysqlsh.log`
To find the location of %APPDATA% on your system, echo it from the comand-line. For example:

```bash
C:\Users\exampleuser\AppData\Roaming\MySQL\mysqlsh\mysqlsh.log
```

### Log File Location on Unix-based Systems

For a machine running Unix, the default path is `~/.mysqlsh/mysqlsh.log` where “~” represents the user's home directory.
The default user configuration path can be overridden on all platforms by defining the environment variable `MYSQL_USER_CONFIG_HOME`.The value of this variable replaces `%AppData%\MySQL\mysqlsh\` on Windows or `~/.mysqlsh/` on Unix.

## 配置MySQL Shell

> <https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-configuring-options.html>

### 命令使用方法

```bash
MySQL  JS > \option --persist defaultMode=sql
# 设置默认语言格式为 sql，`--persist`代表持久化到配置文件

MySQL  SQL > \option logLevel
5
# 查看参数的配置

MySQL  SQL > \option logLevel 7
# 指定参数的配置，也可以使用 '='

MySQL  SQL > \option logLevel
7

MySQL  SQL > \option --UNSET logLevel
Unrecognized option: --UNSET.
# 根据文档内容，在 mysql shell 里面，是区分大小写的
# 经过测试，在 windows 里面，变量也是区分大小写的

MySQL  SQL > \option --unset logLevel
# 还原指定的参数，如果需要保存到配置文件，使用 --persist

MySQL  SQL > \option logLevel
5
```

- `\option option_name` - print the current value of the option.
- `\option [--persist] option_name value or name=value` - set the value of the option and if --persist is specified save it to the configuration file.
- `\option --unset [--persist] <option_name>` - reset option's value to default and if --persist is specified, removes the option from the MySQL Shell configuration file.

The location of the configuration file is the user configuration path and the file is named `options.json`. Assuming that the default user configuration path has not been overridden by defining the environment variable `MYSQL_USER_CONFIG_HOME`, the path to the configuration file is:

- on Windows `%APPDATA%\MySQL\mysqlsh`
- on Unix `~/.mysqlsh` where ~ represents the user's home directory.

The configuration file is created the first time you customize a configuration option. This file is internally maintained by MySQL Shell and should not be edited manually. If an unrecognized option or an option with an incorrect value is found in the configuration file on startup, MySQL Shell exits with an error.

### 其他配置

logLevel

```bash
MySQL  SQL > \option -l
autocomplete.nameCache          true
batchContinueOnError            false
credentialStore.excludeFilters  []
credentialStore.helper          default
credentialStore.savePasswords   prompt
dba.gtidWaitTimeout             60
defaultMode                     sql
devapi.dbObjectHandles          true
history.autoSave                false
history.maxSize                 1000
history.sql.ignorePattern       *IDENTIFIED*:*PASSWORD*
interactive                     true
logLevel                        5
outputFormat                    table
pager                           ""
passwordsFromStdin              false
sandboxDir                      /root/mysql-sandboxes
showWarnings                    true
useWizards                      true
```

## mysqlsh command line

> <https://dev.mysql.com/doc/mysql-shell/8.0/en/mysqlsh.html#option_mysqlsh_user>

简单来说，和 mysql client 命令行选项保持高度一致

```sql
mysqlsh -uroot -pabc123 -S /tmp/mysql.sock -P3306 -h127.0.0.1 -D database
```

连接实例的能用格式

```bash
mysqlsh [dbuser[:[dbpassword]]@]host[:port][/schema]

\c root:abc123@127.0.0.1:3303/mysql
```

- --vertical, -E
    - Display results of SQL queries vertically.Just like `\G`.

```sql
MySQL  SQL > \connect root@127.0.0.1:3303
Please provide the password for 'root@127.0.0.1:3303': ******
Save password for 'root@127.0.0.1:3303'? [Y]es/[N]o/Ne[v]er (default No): y

MySQL  127.0.0.1:3303 ssl  SQL > use mysql

MySQL  127.0.0.1:3303 ssl  mysql  SQL > 
```

## 附加内容

```bash
set MYSQLSH_PROMPT_THEME=C:\Program Files\MySQL\MySQL Shell 8.0\share\mysqlsh\prompt\prompt_256inv.json
```

关于提示符的修改，查看下面的文章
> <https://mysql.wisborg.dk/2018/08/02/configuring-the-mysql-shell-prompt/>

简单来说，在 `/usr/share/mysqlsh/prompt` 目录里，有内置的模板，通过`cp`到`~/.mysqlsh/prompt.json`启用。

以下是我喜欢的一个模板，对`prompt_256inv.json`进行了换行处理

```cnf
cat << eof > /root/.mysqlsh/prompt.json
{
    "classes" : {
      "SQL" : {
        "fg" : "50"
      },
      "JS" : {
        "fg" : "221"
      },
      "Py" : {
        "fg" : "25"
      },
      "schema" : {
        "text": "%schema% "
      },
      "noschema" : {
        "text": ""
      },
      "disconnected": {
      },
      "sslSSL": {
        "text": "ssl ",
        "fg": "blue"
      },
      "ssl" : {
        "text": ""
      },
      "hostx" : {
        "text": "%user%@%host%:%port%+ "
      },
      "hostc" : {
        "text": "%user%@%host%:%port% "
      },
      "production" : {
        "text": " PRODUCTION ",
        "bg": "red",
        "fg": "white"
      }
    },
    "variables" : {
      "is_production": {
          "match" : {
              "pattern": "*;%host%;*",
              "value": ";%env:PRODUCTION_SERVERS%;"
          },
          "if_true" : "production",
          "if_false" : ""
      }
    },
    "symbols" : {
      "separator" : "",
      "separator2" : "",
      "ellipsis" : "..."
    },
    "prompt" : {
      "text" : "> ",
      "cont_text" : "%linectx%> "
    },
    "segments": [
      {
        "classes": ["disconnected%host%", "%is_production%"]
      },
      {
        "text": "My",
        "fg": "blue"
      },
      {
        "separator": "",
        "text": "SQL ",
        "fg": "blue"
      },
      {
        "classes": ["disconnected%host%", "host%session%"],
        "shrink": "truncate_on_dot",
        "fg": 123,
        "weight": 10,
        "padding" : 0
      },
      {
        "classes": ["ssl%ssl%"],
        "padding": 0
      },
      {
        "classes": ["noschema%schema%", "schema"],
        "fg": 197,
        "shrink": "ellipsize",
        "weight": -1,
        "padding" : 0
      },
      {
        "break": true
      },
      {
        "classes": ["%Mode%"],
        "text": "%Mode%",
        "padding" : 0
      }
    ]
  }
  
eof
```
